zabbix_export:
  version: '5.2'
  date: '2021-03-22T21:47:42Z'
  groups:
    -
      name: Templates/Modules
  templates:
    -
      template: 'Template Module Zypper updateinfo by Zabbix trapper'
      name: 'Template Module Zypper updateinfo by Zabbix trapper'
      description: |
        Retrieve information about available updates and security fixes on SUSE or derivatives using zypper.
        
        Requires zypper-updateinfo.py script to be run periodically on host to send the item data to Zabbix.
        
        Created by Robin Roevens (robin.roevens (at) disroot.org)
      groups:
        -
          name: Templates/Modules
      applications:
        -
          name: 'Package updates'
        -
          name: Patches
        -
          name: Security
        -
          name: 'Zabbix raw items'
      items:
        -
          name: 'List of available package updates'
          type: DEPENDENT
          key: zypper.updateinfo.packages
          delay: '0'
          history: 7d
          trends: '0'
          value_type: TEXT
          description: 'List of package updates available and not yet installed.'
          applications:
            -
              name: 'Package updates'
          preprocessing:
            -
              type: JSONPATH
              parameters:
                - $.packages.list
            -
              type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          master_item:
            key: zypper.updateinfo.raw
        -
          name: 'Available package updates'
          type: DEPENDENT
          key: 'zypper.updateinfo.packages[all]'
          delay: '0'
          history: 7d
          description: 'Number of available and not yet installed updates in all enabled repositories'
          applications:
            -
              name: 'Package updates'
          preprocessing:
            -
              type: JSONPATH
              parameters:
                - $.packages.all
          master_item:
            key: zypper.updateinfo.raw
          triggers:
            -
              expression: '{nodata({$ZYPPER.UPDATEINFO.MAXAGE})}=1'
              name: 'No new zypper update information received for {$ZYPPER.UPDATEINFO.MAXAGE}'
              priority: WARNING
              description: 'zypper-updateinfo.py script did not run or failed to run within {$ZYPPER_UPDATEINFO_MAXAGE}. Check if the script is working correctly and if a Systemd timer or cronjob is set up for it to run at expected intervals.'
        -
          name: 'Zypper updateinfo'
          type: TRAP
          key: zypper.updateinfo.raw
          delay: '0'
          history: '0'
          trends: '0'
          value_type: TEXT
          description: 'Raw package and patch updates info as generated by the zypper-updateinfo.py script'
          applications:
            -
              name: 'Zabbix raw items'
        -
          name: 'Known vulnerabilities'
          type: DEPENDENT
          key: zypper.updateinfo.security.cves
          delay: '0'
          history: 7d
          trends: '0'
          value_type: TEXT
          description: 'The system or some software on the system is vulnerable to these known vulnerabilities. Check http://cve.mitre.org for detailed information about each vulnerability.'
          applications:
            -
              name: Security
          preprocessing:
            -
              type: JSONPATH
              parameters:
                - $.patches.security.cves
            -
              type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          master_item:
            key: zypper.updateinfo.raw
      discovery_rules:
        -
          name: 'Patch category/severity discovery'
          type: TRAP
          key: zypper.updateinfo.patch_category.discovery
          delay: '0'
          filter:
            conditions:
              -
                macro: '{#CATEGORY}'
                value: '{$ZYPPER.PATCH.CATEGORY_FILTER}'
                formulaid: A
              -
                macro: '{#SEVERITY}'
                value: '{$ZYPPER.PATCH.SEVERITY_FILTER}'
                formulaid: B
          lifetime: '0'
          item_prototypes:
            -
              name: 'Available {#SEVERITY} {#CATEGORY} patches'
              type: DEPENDENT
              key: 'zypper.updateinfo.patches[{#CATEGORY},{#SEVERITY}]'
              delay: '0'
              history: 7d
              applications:
                -
                  name: Patches
              preprocessing:
                -
                  type: JSONPATH
                  parameters:
                    - '$.patches.{#CATEGORY}.{#SEVERITY}'
              master_item:
                key: zypper.updateinfo.raw
              trigger_prototypes:
                -
                  expression: '{last()}<>0'
                  name: 'New {#SEVERITY} {#CATEGORY} patches are available'
                  description: 'One or more {#CATEGORY} patches with {#SEVERITY} severity are available for the system.'
          overrides:
            -
              name: 'Adapt trigger severity to High'
              step: '1'
              stop: STOP
              filter:
                conditions:
                  -
                    macro: '{#SEVERITY}'
                    value: ^(critical|high)$
                    formulaid: B
                  -
                    macro: '{#CATEGORY}'
                    value: ^(security|recommended)$
                    formulaid: A
              operations:
                -
                  operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'New .* patches are available'
                  severity: HIGH
            -
              name: 'Adapt trigger severity to Average'
              step: '2'
              stop: STOP
              filter:
                conditions:
                  -
                    macro: '{#SEVERITY}'
                    value: important
                    formulaid: B
                  -
                    macro: '{#CATEGORY}'
                    value: ^(security|recommended)
                    formulaid: A
              operations:
                -
                  operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'New .* patches are available'
                  severity: AVERAGE
            -
              name: 'Adapt trigger severity to Warning'
              step: '3'
              stop: STOP
              filter:
                evaltype: FORMULA
                formula: '(A and B) or (C and D)'
                conditions:
                  -
                    macro: '{#CATEGORY}'
                    value: ^(security|recommended)$
                    formulaid: A
                  -
                    macro: '{#SEVERITY}'
                    value: moderate
                    formulaid: B
                  -
                    macro: '{#CATEGORY}'
                    value: ^(optional|feature|document|yast)$
                    formulaid: C
                  -
                    macro: '{#SEVERITY}'
                    value: ^(critical|important)$
                    formulaid: D
              operations:
                -
                  operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'New .* patches are available'
                  severity: WARNING
            -
              name: 'Adapt trigger severity to Information'
              step: '4'
              stop: STOP
              filter:
                evaltype: FORMULA
                formula: '(A and B) or (C and D)'
                conditions:
                  -
                    macro: '{#CATEGORY}'
                    value: ^(security|recommended)$
                    formulaid: A
                  -
                    macro: '{#SEVERITY}'
                    value: low
                    formulaid: B
                  -
                    macro: '{#CATEGORY}'
                    value: ^(optional|feature|document|yast)$
                    formulaid: C
                  -
                    macro: '{#SEVERITY}'
                    value: ^(moderate|low)$
                    formulaid: D
              operations:
                -
                  operationobject: TRIGGER_PROTOTYPE
                  operator: REGEXP
                  value: 'New .* patches are available'
                  severity: INFO
        -
          name: 'Package update repositories discovery'
          type: TRAP
          key: zypper.updateinfo.repositories.discovery
          delay: '0'
          filter:
            conditions:
              -
                macro: '{#ENABLED}'
                value: '{$ZYPPER.REPO.ENABLED_FILTER}'
                formulaid: C
              -
                macro: '{#AUTOREFRESH}'
                value: '{$ZYPPER.REPO.AUTOREFRESH_FILTER}'
                formulaid: B
              -
                macro: '{#ALIAS}'
                value: '{$ZYPPER.REPO.ALIAS_FILTER}'
                formulaid: A
          lifetime: '0'
          item_prototypes:
            -
              name: 'Available package updates in {#NAME}'
              type: DEPENDENT
              key: 'zypper.updateinfo.packages[{#ALIAS}]'
              delay: '0'
              history: 7d
              description: 'Number of package updates currently available in repository {#NAME} ({#ALIAS})'
              applications:
                -
                  name: 'Package updates'
              preprocessing:
                -
                  type: JSONPATH
                  parameters:
                    - '$.packages.["{#ALIAS}"]'
              master_item:
                key: zypper.updateinfo.raw
      macros:
        -
          macro: '{$ZYPPER.PATCH.CATEGORY_FILTER}'
          value: ^(security|recommended|optional|feature|document|yast)$
          description: 'Patch categories to monitor for new patches'
        -
          macro: '{$ZYPPER.PATCH.SEVERITY_FILTER}'
          value: ^(critical|important|moderate|low|unspecified)$
          description: 'Patch severities to monitor for new patches'
        -
          macro: '{$ZYPPER.REPO.ALIAS_FILTER}'
          value: '^(.*)$'
          description: 'Filter on alias of repositories to discover'
        -
          macro: '{$ZYPPER.REPO.AUTOREFRESH_FILTER}'
          value: ^(0|1)$
          description: 'Filter on ''autorefresh'' attribute of repositories to discover'
        -
          macro: '{$ZYPPER.REPO.ENABLED_FILTER}'
          value: '1'
          description: 'Filter on ''enabled'' attribute of repositories to discover'
        -
          macro: '{$ZYPPER.UPDATEINFO.MAXAGE}'
          value: 2d
          description: 'Max age of available security updates information'
  triggers:
    -
      expression: '{Template Module Zypper updateinfo by Zabbix trapper:zypper.updateinfo.packages[all].last()}>0 and {Template Module Zypper updateinfo by Zabbix trapper:zypper.updateinfo.packages.strlen()}>0'
      name: 'New package updates are available'
      opdata: '{ITEM.VALUE1}'
      priority: INFO
      description: |
        One or more package updates are available for the system.
        Following packages can be updated:
        {ITEM.VALUE2}
